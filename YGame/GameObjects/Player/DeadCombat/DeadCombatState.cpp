#include "DeadCombatState.h"
#include "../Player.h"
#include "../Movement/PlayerMovement.h"
#include "Systems/GameTime/GameTime.h"

/// <summary>
/// コンストラクタ
/// </summary>
/// <param name="combat">戦闘システムへのポインタ</param>
DeadCombatState::DeadCombatState(PlayerCombat* combat) : combat_(combat) {
	// 特に初期化処理はなし（必要に応じて追加）
}

/// <summary>
/// 死亡状態に入った時の処理
/// </summary>
void DeadCombatState::OnEnter() {
	auto* player = combat_->GetOwner();
	auto* obj = player->GetObject3d();

	//---------------------------------------------------------------------------------------------
	// 時間の進行を減速（演出用）
	//---------------------------------------------------------------------------------------------
	YoRigine::GameTime::SetTimeScale(0.75f);

	//---------------------------------------------------------------------------------------------
	// 死亡アニメーション再生設定
	//---------------------------------------------------------------------------------------------
	obj->SetMotionSpeed(player->GetMotionSpeed(3));  // motionSpeed[3] = 死亡アニメ速度
	obj->SetChangeMotion("Player.gltf", MotionPlayMode::Once, "Death2");

	//---------------------------------------------------------------------------------------------
	// プレイヤー操作無効化
	//---------------------------------------------------------------------------------------------
	player->GetMovement()->SetCanMove(false);
	player->GetMovement()->SetCanRotate(false);
	player->GetMovement()->ForceStop();

	//---------------------------------------------------------------------------------------------
	// 状態変数初期化
	//---------------------------------------------------------------------------------------------
	deathTimer_ = 0.0f;
	isAnimationFinished_ = false;

	//---------------------------------------------------------------------------------------------
	// 通知ログ出力（デバッグ用）
	//---------------------------------------------------------------------------------------------
	combat_->NotifyAction("プレイヤー死亡");
}

/// <summary>
/// 死亡状態を抜ける時の処理（復活などのフックポイント）
/// </summary>
void DeadCombatState::OnExit() {
	// 今のところ特に何もしない
	// ※ 復活演出・リスポーン演出が追加された場合、ここで復帰準備処理を行う

	YoRigine::GameTime::SetTimeScale(1.0f);
}

/// <summary>
/// 毎フレームの更新処理
/// </summary>
/// <param name="deltaTime">経過時間</param>
void DeadCombatState::Update(float deltaTime) {
	//---------------------------------------------------------------------------------------------
	// アニメーション再生時間を更新
	//---------------------------------------------------------------------------------------------
	deathTimer_ += deltaTime;

	//---------------------------------------------------------------------------------------------
	// アニメーション終了を検出
	//---------------------------------------------------------------------------------------------
	if (!isAnimationFinished_) {
		auto* player = combat_->GetOwner();
		auto* obj = player->GetObject3d();

		// モーションシステムが存在するか確認
		if (obj->GetModel() && obj->GetModel()->GetMotionSystem()) {
			auto* motionSystem = obj->GetModel()->GetMotionSystem();

			// アニメーションが最後まで再生されたら最終フレームで停止
			if (motionSystem->IsFinished()) {
				// Idleへ戻す（再生終了後の安定状態）
				YoRigine::GameTime::Pause();
				// 注意：
				// MotionPlayMode::Once のため自動的に停止するが、
				// 状態遷移を行うことで再度の行動を明確にブロックできる
				isAnimationFinished_ = true;
			}
		}
	}

	//---------------------------------------------------------------------------------------------
	// 死亡中は操作・入力を受け付けない
	//---------------------------------------------------------------------------------------------
	// ※ 復活・リトライ処理などを追加する場合はここで管理
}
